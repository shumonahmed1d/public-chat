<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Public Chat — Debug Friendly</title>
  <style>
    :root{--bg:#f3f6fb;--card:#fff;--accent:#276ef1;--muted:#6b7280}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#eef6ff 0%,var(--bg) 100%);font-family:Inter,system-ui,"Noto Sans Bengali",sans-serif;color:#111}
    .wrap{max-width:920px;margin:0 auto;padding:16px;display:flex;flex-direction:column;height:100vh;box-sizing:border-box}
    header{display:flex;align-items:center;gap:12px;padding:6px 4px}
    h1{margin:0;font-size:20px}
    .status{font-size:13px;color:var(--muted);margin-left:8px}
    .chat-card{background:var(--card);border-radius:12px;padding:12px;flex:1;display:flex;flex-direction:column;box-shadow:0 6px 20px rgba(34,60,80,0.06);min-height:0}
    #messages{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth}
    .msg{max-width:78%;padding:10px 12px;border-radius:12px;box-shadow:0 2px 6px rgba(16,24,40,0.04);position:relative;word-break:break-word}
    .msg--me{align-self:flex-end;background:#e8f0ff}
    .msg--other{align-self:flex-start;background:#fff}
    .time{font-size:11px;color:var(--muted);margin-top:6px;text-align:right}
    .hint{font-size:13px;color:var(--muted);text-align:center;margin-bottom:6px}
    .chat-footer{position:fixed;left:0;right:0;bottom:0;display:flex;justify-content:center;padding:12px;background:linear-gradient(to top, rgba(243,246,251,0.95), rgba(243,246,251,0.6));box-shadow:0 -8px 30px rgba(16,24,40,0.06);backdrop-filter: blur(4px);z-index:40;padding-bottom:calc(env(safe-area-inset-bottom)+12px)}
    .composer{width:100%;max-width:920px;display:flex;gap:8px;align-items:center}
    .input{flex:1;display:flex;gap:8px;align-items:center;background:#fff;border-radius:999px;padding:8px;border:1px solid rgba(16,24,40,0.06)}
    .input input{flex:1;border:0;outline:none;padding:10px 8px;font-size:15px;border-radius:8px}
    button.send{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;font-weight:600}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:12vh;background:#111;color:#fff;padding:8px 12px;border-radius:8px;font-size:13px;opacity:0;pointer-events:none;transition:all .25s ease;z-index:60}
    .toast.show{opacity:1}
    .debug{font-size:13px;color:#b03;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="width:44px;height:44px;background:#276ef1;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">C</div>
      <div>
        <h1>Public Chat</h1>
        <div style="display:flex;gap:8px;align-items:center">
          <span class="status" id="status">Connecting…</span>
          <span id="status-emoji"></span>
        </div>
      </div>
    </header>

    <div class="chat-card">
      <div class="hint" id="hint">Loading messages…</div>
      <div id="messages" aria-live="polite"></div>
      <div id="debugArea" class="debug" style="display:none"></div>
    </div>
  </div>

  <div class="chat-footer" id="chatFooter" style="visibility:hidden">
    <div class="composer">
      <div class="input">
        <input id="textInput" type="text" placeholder="Message লিখে Enter চাপো অথবা Send টিপো..." autocomplete="off" />
      </div>
      <button class="send" id="sendBtn">Send</button>
    </div>
  </div>

  <div class="toast" id="toast">Copied</div>

  <script type="module">
    // ---------- config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyD_Z7-3oe8KK5XA6OyKe0D-tS_Z6KKmyZY",
      authDomain: "mychat-c5b4e.firebaseapp.com",
      databaseURL: "https://mychat-c5b4e-default-rtdb.firebaseio.com",
      projectId: "mychat-c5b4e",
      storageBucket: "mychat-c5b4e.firebasestorage.app",
      messagingSenderId: "1023283718484",
      appId: "1:1023283718484:web:c58197b559aa1e790640c1",
      measurementId: "G-YB9XZPPH41"
    };

    // UI elements
    const statusEl = document.getElementById('status');
    const hintEl = document.getElementById('hint');
    const messagesEl = document.getElementById('messages');
    const debugEl = document.getElementById('debugArea');
    const textInput = document.getElementById('textInput');
    const sendBtn = document.getElementById('sendBtn');
    const chatFooter = document.getElementById('chatFooter');
    const toast = document.getElementById('toast');

    function showToast(txt){
      toast.textContent = txt;
      toast.classList.add('show');
      clearTimeout(window._t);
      window._t = setTimeout(()=> toast.classList.remove('show'), 1400);
    }
    function setStatus(txt, color = '#6b7280'){ statusEl.textContent = txt; statusEl.style.color = color; }

    // small helper to show debug error
    function showDebug(msg){
      debugEl.style.display = 'block';
      debugEl.textContent = msg;
      console.warn('CHAT-DEBUG:', msg);
    }

    // client id
    let CLIENT_ID = localStorage.getItem('chat_clientId');
    if(!CLIENT_ID){ CLIENT_ID = 'c_' + Math.random().toString(36).slice(2,10); localStorage.setItem('chat_clientId', CLIENT_ID); }

    // imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

    // try initialize and attach listeners safely
    let db, messagesRef;
    try {
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      db = database;
      messagesRef = ref(db, 'messages');
      setStatus('Connected ✅', '#0a8a0a');
      hintEl.textContent = 'Messages টিপলে copy হবে';
      chatFooter.style.visibility = 'visible';
    } catch (e){
      setStatus('Init failed ❌', '#b03');
      showDebug('Firebase initialize failed: ' + (e && e.message ? e.message : e));
      // don't continue if firebase init failed
    }

    // if DB initialized, attach listener
    if(messagesRef){
      try {
        // show last 200 messages
        onChildAdded(query(messagesRef, limitToLast(200)), snap => {
          try {
            const val = snap.val();
            if(!val) return;
            renderMessage(val);
          } catch (err) {
            showDebug('Render error: ' + err && err.message);
          }
        });
        // success
        setStatus('Live — receiving messages', '#0a6');
        hintEl.textContent = 'মেসেজ ট্যাপ করলে কপি হবে';
      } catch (e){
        setStatus('Listener failed ❌', '#b03');
        showDebug('Listener attach failed: ' + (e && e.message ? e.message : e));
      }
    } else {
      showDebug('messagesRef not available');
    }

    // render message
    function escapeHTML(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }
    function renderMessage(data){
      const el = document.createElement('div');
      const isMe = data.clientId && data.clientId === CLIENT_ID;
      el.className = 'msg ' + (isMe ? 'msg--me' : 'msg--other');
      const safe = escapeHTML(data.text || '');
      el.innerHTML = `<div>${safe}</div><div class="time">${data.time?new Date(data.time).toLocaleString():''}</div>`;
      el.addEventListener('click', async ()=> {
        try { await navigator.clipboard.writeText(data.text||''); showToast('Copied'); }
        catch(e){ showToast('Copy failed'); console.error(e); }
      });
      messagesEl.appendChild(el);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // send
    async function sendMessage(){
      const txt = textInput.value.trim();
      if(!txt) return;
      if(!messagesRef){ showToast('Not connected'); return; }
      try {
        await push(messagesRef, { text: txt, time: Date.now(), clientId: CLIENT_ID });
        textInput.value = '';
        textInput.focus();
      } catch (e){
        showToast('Send failed');
        showDebug('Send failed: ' + (e && e.message ? e.message : e));
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    textInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter'){ e.preventDefault(); sendMessage(); } });

    // network and visibility handling
    window.addEventListener('offline', () => { setStatus('Offline — check network', '#b03'); showDebug('You are offline'); });
    window.addEventListener('online', () => { setStatus('Online — reconnecting…', '#d90'); setTimeout(()=> setStatus('Live — receiving messages', '#0a6'), 1200); });

    // initial no-messages hint
    setTimeout(()=> {
      if(messagesEl.children.length === 0) {
        hintEl.textContent = 'কোনো message পাওয়া যায়নি — Send করে দেখো';
      }
    }, 800);

  </script>
</body>
</html>
